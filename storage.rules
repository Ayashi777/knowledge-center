rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper to check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Helper to check if user is admin via Firestore
    function isAdmin() {
      return isAuth() && 
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function userRole() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role;
    }

    function getDocument(docId) {
      return firestore.get(/databases/(default)/documents/documents/$(docId)).data;
    }

    function documentExists(docId) {
      return firestore.exists(/databases/(default)/documents/documents/$(docId));
    }

    function canViewDocument(docId) {
      return documentExists(docId) && (
        isAdmin() ||
        (
          ('viewPermissions' in getDocument(docId)) &&
          getDocument(docId).viewPermissions.size() > 0 &&
          isAuth() &&
          userRole() in getDocument(docId).viewPermissions
        ) ||
        (
          !('viewPermissions' in getDocument(docId)) ||
          getDocument(docId).viewPermissions.size() == 0
        )
      );
    }

    function canDownloadDocument(docId) {
      return documentExists(docId) && (
        isAdmin() ||
        (
          ('downloadPermissions' in getDocument(docId)) &&
          getDocument(docId).downloadPermissions.size() > 0 &&
          isAuth() &&
          userRole() in getDocument(docId).downloadPermissions
        ) ||
        (
          !('downloadPermissions' in getDocument(docId)) ||
          getDocument(docId).downloadPermissions.size() == 0
        ) && canViewDocument(docId)
      );
    }

    function isThumbnailFile(fileName) {
      return fileName.matches('^thumbnail\\..+$') || fileName.matches('^cover_.+$');
    }

    // New structured paths for document assets
    match /documents/{docId}/files {
      allow read: if canDownloadDocument(docId);
      allow write: if isAdmin();
    }

    match /documents/{docId}/files/{allPaths=**} {
      allow read: if canDownloadDocument(docId);
      allow write: if isAdmin();
    }

    match /documents/{docId}/images {
      allow read: if canViewDocument(docId);
      allow write: if isAdmin();
    }

    match /documents/{docId}/images/{allPaths=**} {
      allow read: if canViewDocument(docId);
      allow write: if isAdmin();
    }

    // Legacy root-level files under documents/{docId}/...
    match /documents/{docId}/{fileName} {
      allow read: if isThumbnailFile(fileName) ? canViewDocument(docId) : canDownloadDocument(docId);
      allow write: if isAdmin();
    }

    // Default: allow read for auth users, write only for admin
    match /{allPaths=**} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
  }
}
